@implements IDisposable

@if (allState.ShowVacation)
{
	<div class="container mt-5">
		<div class="row">
			<div class="col-lg-12">
				<div class="card border-success shadow-lg">
					<div class="card-header">
						<h4 class="float-start">Manage Employee's Vacations</h4>
					</div>

					<div class="card-header" style="max-height:580px;overflow-x:hidden;overflow-y:scroll">
						<div class="card-body">
							<!--Controls to Export to Excel, PDF and Print Table results-->
							<div class="mb-4">
								<button class="btn btn-sm btn-success mr-1" @onclick="ExportToExcel">
									<span class="bi bi-file-earmark-excel"></span>
									Excel Export
								</button>
								<button class="btn btn-sm btn-primary" @onclick="ExportToPdf">
									<span class="bi bi-file-earmark-pdf-fill"></span>
									Pdf Export
								</button>
							</div>

							<MudTable Items="@Vacations" Dense="true" Hover="true" Bordered="true" Striped="false">
								<HeaderContent>
									<MudTh>Employee ID</MudTh>
									<MudTh>Type</MudTh>
									<MudTh>Start Date</MudTh>
									<MudTh>End Date</MudTh>
									<MudTh>Number of days</MudTh>
									<MudTh>Actions</MudTh>
								</HeaderContent>
								<RowTemplate>
									<MudTd DataLabel="Employee ID">@context.EmployeeId</MudTd>
									<MudTd DataLabel="Type">@context!.VacationType!.Name</MudTd>
									<MudTd DataLabel="Start Date">@context.StartDate</MudTd>
									<MudTd DataLabel="End Date">@context.EndDate</MudTd>
									<MudTd DataLabel="Number of days">@context.NumberOfDays</MudTd>
									<MudTd DataLabel="Actions">
										<div>
											<i class="bi bi-pencil text-info" @onclick="() => EditClicked(context!)" style="cursor:pointer;"></i>
											<i class="bi bi-trash text-danger" @onclick="() => DeleteClicked(context!)" style="cursor:pointer;"></i>
										</div>
									</MudTd>
								</RowTemplate>
								<PagerContent>
									<MudTablePager />
								</PagerContent>
							</MudTable>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
}

<style>
	#cursorStyle {
		cursor: pointer;
	}
</style>

<VacationDialog @ref="vacationDialog" 
	Vacation="Vacation" 
	VacationTypes="VacationTypes" 
	HandleSaveOperationEvent="HandleSaveOperationEvent"
/>

@code {
	private SfGrid<Vacation>? DefaultGrid;
	private VacationDialog? vacationDialog;
	private Vacation Vacation { get; set; } = new();
	private List<Vacation> Vacations { get; set; } = new();
	private List<VacationType> VacationTypes { get; set; } = new();
	protected override async Task OnInitializedAsync()
	{
		await GetTypes();
		await GetVacations();
		allState.Action += StateHasChanged;
	}

	private async Task GetTypes() => VacationTypes = await vacationTypeService.GetAll(Constants.VacationTypeBaseUrl);
	private async Task GetVacations() => Vacations = await vacationService.GetAll(Constants.VacationBaseUrl);
	void OpenDialog() => vacationDialog?.OpenDialog();

	private async Task HandleSaveOperationEvent(Vacation vacation)
	{
		var result = await vacationService.Update(vacation, Constants.VacationBaseUrl);
		bool isValid = await DisplayMessage(result.Flag, result.Message);
		if (isValid)
		{
			Vacation = new();
			await GetVacations();
		}
	}

	private void EditClicked(Vacation item)
	{
		Vacation = item;
		vacationDialog?.ChangeTitle("Edit Vacation");
		vacationDialog?.OpenDialog();
	}

	private async Task DeleteClicked(Vacation item)
	{
		bool confirm = await alertService.ShowConfirmation($"Are you sure you want to delete this?", "Confirm Delete");
		if (!confirm) return;

		var result = await vacationService.Delete(item.Id, Constants.VacationBaseUrl);

		if (await DisplayMessage(result.Flag, result.Message))
			await GetVacations();
	}

	private async Task<bool> DisplayMessage(bool flag, string message)
	{
		if (flag)
		{
			await alertService.ShowSuccessToast(message);

			return true;
		}
		else
		{
			await alertService.ShowErrorToast(message);
			return false;
		}
	}

	private async Task ExportToExcel() => await ExcelService.Export(Vacations, "Vacations.xlsx");
	private async Task ExportToPdf() => await PdfService.Export(Vacations, "Vacations.pdf");
	
	public void Dispose() => allState.Action -= StateHasChanged;
}